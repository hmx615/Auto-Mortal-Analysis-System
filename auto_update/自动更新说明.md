# 🔄 自动更新系统

自动定时爬取最新牌谱并进行AI分析，实现完全无感的持续监控。

## 💡 为什么需要自动更新？

- **API更新慢**: amae-koromo API只更新上个月的数据
- **网页有最新**: 牌谱屋网页端有当月最新对局
- **手动太麻烦**: 每次都要手动运行爬虫和分析
- **想要实时性**: 希望打完就能自动分析

## ✨ 功能特点

- ✅ **完全无感**: 后台静默运行，不弹窗
- ✅ **自动去重**: 只分析新增牌谱，避免重复
- ✅ **定时执行**: 可选间隔（6/12/24小时或自定义）
- ✅ **持续监控**: 开机自启，持续运行
- ✅ **日志记录**: 所有操作都有日志可查

## 🚀 使用方式

### 方式1: 手动启动（带窗口）

**适合**: 临时使用、测试

```batch
双击运行: run_auto_update.bat
```

- 显示运行窗口
- 可以看到实时输出
- 按 Ctrl+C 停止

---

### 方式2: 开机自启（最无感）⭐⭐⭐

**适合**: 想要完全自动化，不用管

#### 安装步骤:

1. **右键"以管理员身份运行"**:
   ```
   install_auto_update.bat
   ```

2. **选择更新间隔**:
   - 1: 每6小时（推荐 - 及时更新）
   - 2: 每12小时（默认 - 平衡）
   - 3: 每24小时（省资源）
   - 4: 自定义（输入分钟数）

3. **按提示完成安装**

4. **重启电脑**（或手动启动任务）

#### 安装后效果:
- **系统启动**时自动运行
- 完全后台运行（无窗口）
- 按所选间隔自动检查新牌谱并分析
- 查看日志: `auto_update.log`

#### 卸载方式:
1. 打开"任务计划程序"（Windows搜索框输入）
2. 找到"MortalAutoUpdate"
3. 右键 → 删除

---

## ⚙️ 配置

### 修改更新间隔

安装时已选择，如需修改：

**方式1: 重新运行安装脚本**（推荐）
```batch
右键"以管理员身份运行": install_auto_update.bat
```
选择新的间隔，会自动更新配置

**方式2: 手动编辑**
编辑 `auto_update.py`，修改以下参数：
```python
UPDATE_INTERVAL_MINUTES = 720  # 改为你想要的分钟数
```

常用间隔:
- `360` - 每6小时（推荐）
- `720` - 每12小时（默认）
- `1440` - 每24小时（省资源）

### 配置2Captcha API Key ⭐

自动更新需要从环境变量读取2Captcha API Key。

**Windows 设置环境变量**:

1. 右键"此电脑" → 属性 → 高级系统设置 → 环境变量
2. 在"用户变量"中点击"新建"
3. 变量名: `TWOCAPTCHA_API_KEY`
4. 变量值: 你的API Key（从 https://2captcha.com 获取）
5. 确定保存

**或使用命令行临时设置**:
```batch
set TWOCAPTCHA_API_KEY=YOUR_API_KEY
```

**注意**: 如果不设置API Key，系统会使用手动模式（需要人工输入验证码）

---

## 📊 工作流程

```
┌─────────────────────────────────────┐
│  按设定间隔自动执行                    │
└──────────┬──────────────────────────┘
           │
           ↓
   ┌───────────────┐
   │ 1. 爬取网页    │ ← 只爬最新数据（快）
   └───────┬───────┘
           │
           ↓
   ┌───────────────┐
   │ 2. 去重检查    │ ← 跳过已分析的
   └───────┬───────┘
           │
           ↓
   ┌───────────────┐
   │ 3. AI分析      │ ← Headless模式
   └───────┬───────┘
           │
           ↓
   ┌───────────────┐
   │ 4. 保存结果    │ ← 更新CSV文件
   └───────┬───────┘
           │
           ↓
   ┌───────────────┐
   │ 5. 记录日志    │ ← auto_update.log
   └───────────────┘
```

---

## 📝 日志查看

所有操作都会记录在 `auto_update.log` 文件中：

```
[2025-12-14 10:00:00] 开始自动更新...
[2025-12-14 10:00:00] 当前已分析: 129 场
[2025-12-14 10:00:05] 开始爬取最新牌谱...
[2025-12-14 10:00:15] ✓ 爬虫完成
[2025-12-14 10:00:15] 开始AI分析...
[2025-12-14 10:05:30] ✓ AI分析完成
[2025-12-14 10:05:30] ✓ 本次更新: 新增 3 场分析
[2025-12-14 10:05:30] 总计已分析: 132 场
[2025-12-14 10:05:30] 自动更新完成
[2025-12-14 10:05:30] 下次更新时间: 720 分钟后
```

---

## ⚠️ 注意事项

### 系统要求
- Windows 10/11
- Python 已安装
- Edge浏览器（用于Selenium）
- 网络连接稳定

### 资源占用
- **CPU**: 低（分析时略高）
- **内存**: 约200-500MB（Headless浏览器）
- **网络**: 每次更新约5-20MB流量
- **硬盘**: 日志文件会逐渐增大（可手动清理）

### 防睡眠
如果电脑进入睡眠，任务会暂停。建议：
- 设置"从不睡眠"（电源选项）
- 或使用台式机24小时运行

### 2Captcha费用
- 每局分析需要1次验证码识别
- 约 $0.002 USD/次
- 100局 ≈ $0.20 USD
- 1000局 ≈ $2.00 USD

---

## 🆘 常见问题

### Q: 如何确认是否在运行？
**A**:
1. 检查任务管理器是否有 `pythonw.exe` 进程
2. 查看 `auto_update.log` 最新日志时间
3. 查看 `mortal_results_temp.csv` 文件修改时间

### Q: 如何停止自动更新？
**A**:
- 方式1（临时）: 任务管理器结束 `pythonw.exe`
- 方式2（永久）: 任务计划程序中删除 "MortalAutoUpdate"

### Q: 为什么没有新增数据？
**A**:
- 可能你没有打新对局
- 或者网页端还未更新（通常有几分钟延迟）
- 检查日志查看具体原因

### Q: 日志文件太大怎么办？
**A**: 可以定期手动删除或清空 `auto_update.log`，不影响运行

### Q: 可以同时手动运行分析吗？
**A**: 不建议。可能会导致CSV文件冲突。建议先停止自动更新。

---

## 🎯 最佳实践

### 推荐配置:
1. **安装开机自启** - 一劳永逸
2. **选择6-12小时间隔** - 平衡实时性和资源
3. **定期查看日志** - 确保正常运行
4. **充足2Captcha额度** - 至少$3以上

### 使用场景:
- ✅ 台式机24小时开机 - 完美
- ✅ 笔记本日常使用 - 良好
- ❌ 经常关机/睡眠 - 不推荐

---

## 📈 效果展示

假设你每天打10局：

| 时间 | 传统方式 | 自动更新 |
|------|----------|----------|
| 打完当天 | 手动爬取→手动分析（麻烦） | 自动完成 ✓ |
| 第二天 | 手动爬取→手动分析（麻烦） | 自动完成 ✓ |
| 一周后 | 累积70局，一次性处理（慢） | 每天自动更新 ✓ |
| 随时查看 | 数据可能过时 | 实时更新数据 ✓ |

---

💡 **提示**: 首次使用建议先手动运行一次 `run_auto_update.bat`，确认流程正常后再安装开机自启。
